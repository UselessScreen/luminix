name: Release

on:
  push:
    branches: [ "master" ]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.new_version.outputs.version }}
      commit_message: ${{ steps.commit.outputs.message }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Get commit message
      id: commit
      run: |
        COMMIT_MSG=$(git log -1 --pretty=%B)
        echo "message<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "Commit message: $COMMIT_MSG"
    
    - name: Determine version bump
      id: version_bump
      run: |
        COMMIT_MSG="${{ steps.commit.outputs.message }}"
        BUMP_TYPE="patch"
        
        if echo "$COMMIT_MSG" | grep -i '\[major\]'; then
          BUMP_TYPE="major"
        elif echo "$COMMIT_MSG" | grep -i '\[minor\]'; then
          BUMP_TYPE="minor"
        fi
        
        echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
        echo "Version bump type: $BUMP_TYPE"
    
    - name: Get current version
      id: current_version
      run: |
        VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].version')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $VERSION"
    
    - name: Update Cargo.toml version
      uses: tj-actions/cargo-bump@v3
      with:
        release_type: ${{ steps.version_bump.outputs.bump_type }}
    
    - name: Get new version
      id: new_version
      run: |
        VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].version')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "New version: $VERSION"
    
    - name: Commit version bump
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add Cargo.toml
        git commit -m "chore: bump version to ${{ steps.new_version.outputs.version }}"
        git push
    
    - name: Create tag
      run: |
        git tag v${{ steps.new_version.outputs.version }}
        git push origin v${{ steps.new_version.outputs.version }}
  
  build-windows:
    needs: release
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: v${{ needs.release.outputs.version }}
    - uses: Swatinem/rust-cache@v2
    
    - name: Build Windows binary
      run: |
        cargo build --release

    - name: Rename Windows binary
      run: |
        ren "target/release/luminix.exe" "luminix-${{ needs.release.outputs.version }}-windows-x86_64.exe"
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: luminix-windows
        path: target/release/luminix-${{ needs.release.outputs.version }}-windows-x86_64.exe
  
  build-linux:
    needs: release
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      success: ${{ steps.build.outcome == 'success' }}
    env:
      folder_name: luminix-${{ needs.release.outputs.version }}-linux-x86_64
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: v${{ needs.release.outputs.version }}
    - uses: Swatinem/rust-cache@v2
    
    - name: Build Linux binary
      id: build
      run: |
        cargo build --release

    - name: Package linux binary
      run: |
        cd target/release
        mkdir -p folder
        mv luminix folder/luminix
        chmod +x folder/luminix
        cp ../../resources/linux_release/* folder
        mv folder ${{env.folder_name}}
        tar -czf ${{env.folder_name}}.tar.gz ${{env.folder_name}}
    
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      if: steps.build.outcome == 'success'
      with:
        name: luminix-linux
        path: target/release/${{env.folder_name}}.tar.gz
  
  create-release:
    needs: [release, build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        merge-multiple: true
        path: ./artifacts

    - name: Clean commit message
      id: clean_msg
      run: |
        COMMIT_MSG="${{ needs.release.outputs.commit_message }}"
        CLEAN_MSG=$(printf '%s' "$COMMIT_MSG" \
          | sed -e 's/\[major\]//g' -e 's/\[minor\]//g' -e 's/[[:space:]]*$//')
        CLEAN_MSG=$(printf "%s" "$CLEAN_MSG")
        echo "clean_message<<EOF" >> $GITHUB_OUTPUT
        echo "$CLEAN_MSG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT


    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.release.outputs.version }}
        name: v${{ needs.release.outputs.version }}
        body: |
          Release v${{ needs.release.outputs.version }}
          
          ${{ steps.clean_msg.outputs.clean_message }}
        draft: false
        prerelease: false
        fail_on_unmatched_files: false
        files: |
          ./artifacts/*